# Jarvis Full Homelab desired spec
# Scope: Phase 0 active now (SSD-only), with Phase 1/2 profile blocks for later activation.
# Safety baseline: no public inbound exposure, Tailscale-only remote access.

profiles:
  active: phase0
  available:
    - phase0
    - phase1
    - phase2

assumptions:
  node: proxmox
  lanBridge: vmbr0
  lanCidr: 192.168.1.0/24
  tailscaleCidr: 100.64.0.0/10
  remoteAccessPolicy: tailscale-only
  notes:
    - No managed switch detected; segmentation with internal bridges is deferred to phase2.
    - VM-level firewall allowlists are defined in firewallPolicies and should be enforced through PVE VM firewall rules and/or in-guest firewall bootstrap scripts.

# -----------------------------------------------------------------------------
# PHASE 0 (ACTIVE): SSD-only MVP
# -----------------------------------------------------------------------------

vms:
  - vmid: 100
    desiredPower: running
  - vmid: 300
    desiredPower: running
  - vmid: 400
    desiredPower: running

vmProvision:
  - name: edge-gateway
    vmid: 100
    node: proxmox
    ensure: running
    cpu:
      cores: 2
      type: host
    memory:
      size: 2048
      balloon: 1024
    disks:
      - interface: scsi
        index: 0
        storage: local-lvm
        size: 32G
        cache: none
        discard: on
        ssd: true
        iothread: true
    networks:
      - interface: net
        index: 0
        model: virtio
        bridge: vmbr0
        firewall: true
    onboot: true
    protection: true
    tags: [env=lab, role=edge-gateway, tier=lan, owner=loic]
    description: "Tailscale edge gateway (Phase0: in-guest Tailscale; Phase2: optional subnet router)"
    ostype: l26
    agent: true
    boot:
      order: [scsi0, net0]

  - name: app-host
    vmid: 300
    node: proxmox
    ensure: running
    cpu:
      cores: 4
      type: host
    memory:
      size: 8192
      balloon: 4096
    disks:
      - interface: scsi
        index: 0
        storage: local-lvm
        size: 128G
        cache: none
        discard: on
        ssd: true
        iothread: true
    networks:
      - interface: net
        index: 0
        model: virtio
        bridge: vmbr0
        firewall: true
    onboot: true
    protection: true
    tags: [env=lab, role=app-host, tier=lan, owner=loic]
    description: "Docker app host: plex/jarvis/monitoring/kargo-preprod"
    ostype: l26
    agent: true
    boot:
      order: [scsi0, net0]

  - name: home-assistant
    vmid: 400
    node: proxmox
    ensure: running
    cpu:
      cores: 2
      type: host
    memory:
      size: 4096
      balloon: 2048
    disks:
      - interface: scsi
        index: 0
        storage: local-lvm
        size: 64G
        cache: none
        discard: on
        ssd: true
        iothread: true
    networks:
      - interface: net
        index: 0
        model: virtio
        bridge: vmbr0
        firewall: true
    onboot: true
    protection: true
    tags: [env=lab, role=home-assistant, tier=lan, owner=loic]
    description: "Home Assistant VM (recommended target OS: HAOS). Tailscale in-guest for phase0 simplicity."
    ostype: l26
    agent: false
    boot:
      order: [scsi0, net0]

networks:
  - name: vmbr0
    node: proxmox
    type: bridge
    autostart: true
    comments: "LAN bridge with physical uplink"

proxmoxDatacenterFirewallOptions:
  options:
    enable: 1
    policy_in: DROP
    policy_out: ACCEPT

proxmoxNodeFirewallOptions:
  - node: proxmox
    options:
      enable: 1
      policy_in: DROP
      policy_out: ACCEPT

proxmoxDatacenterFirewallAliases:
  - name: lan-net
    cidr: 192.168.1.0/24
    comment: LAN subnet
  - name: tailscale-net
    cidr: 100.64.0.0/10
    comment: Tailscale CGNAT range

proxmoxDatacenterFirewallRules:
  - action: ACCEPT
    type: in
    source: 192.168.1.0/24
    comment: Allow LAN baseline in
    enable: true
    pos: 0
  - action: ACCEPT
    type: in
    source: 100.64.0.0/10
    comment: Allow Tailscale baseline in
    enable: true
    pos: 1
  - action: DROP
    type: in
    comment: Default drop inbound
    enable: true
    pos: 999

# Placeholder backup policy on SSD (warns about SSD capacity pressure until phase1)
proxmoxBackupJobs:
  - id: phase0-local-ssd-backup
    enabled: true
    node: proxmox
    storage: local
    schedule: "02:30"
    mode: snapshot
    comment: "Phase0 temporary backup to SSD (move to tank/backups in phase1)"
    options:
      compress: zstd
      prune-backups: "keep-last=3"

# Ensure snapshots exist for risky lifecycle actions
proxmoxVmSnapshots:
  - node: proxmox
    vmid: 100
    name: pre-risky-phase0-edge-gateway
  - node: proxmox
    vmid: 300
    name: pre-risky-phase0-app-host
  - node: proxmox
    vmid: 400
    name: pre-risky-phase0-home-assistant

composeProjects:
  - path: /opt/naas/stacks/plex
    ensure: running
  - path: /opt/naas/stacks/jarvis
    ensure: running
  - path: /opt/naas/stacks/monitoring
    ensure: running
  - path: /opt/naas/stacks/kargo-preprod
    ensure: running

validation:
  enabled: true

# Operational metadata (builder/in-guest orchestration descriptors)
tailscaleConfig:
  installTargets:
    - vmid: 100
      host: edge-gateway
      role: edge-entry
      subnetRouterPhase2: optional
    - vmid: 400
      host: home-assistant
      role: ha-remote-access
  auth:
    mode: ephemeral-or-tagged
    secretRefs:
      edgeGatewayAuthKey: env:TS_AUTHKEY_EDGE_GATEWAY
      homeAssistantAuthKey: env:TS_AUTHKEY_HOME_ASSISTANT
  policy:
    exposePublicInternet: false
    allowInboundOnlyFrom:
      - lan
      - tailscale

dockerStacks:
  hostVmid: 300
  root: /opt/naas
  layout:
    stacksRoot: /opt/naas/stacks
    appdataRoot: /opt/naas/appdata
    logsRoot: /opt/naas/logs
  stacks:
    - name: plex
      composePath: /opt/naas/stacks/plex
      allowedIngress:
        - lan:32400/tcp
        - tailscale:32400/tcp
      volumeHints:
        - /opt/naas/appdata/plex
        - /data/media
    - name: jarvis
      composePath: /opt/naas/stacks/jarvis
      allowedIngress:
        - lan:8080/tcp
        - tailscale:8080/tcp
      secrets:
        - HA_TOKEN from secret manager only
    - name: monitoring
      composePath: /opt/naas/stacks/monitoring
      allowedIngress:
        - lan:3000/tcp
        - lan:9090/tcp
        - lan:3100/tcp
        - tailscale:3000/tcp
    - name: kargo-preprod
      composePath: /opt/naas/stacks/kargo-preprod
      allowedIngress:
        - lan:8088/tcp
        - tailscale:8088/tcp
      privateServices:
        - postgres:5432
        - minio:9000
        - minio-console:9001

firewallPolicies:
  perVmAllowlists:
    - vmid: 100
      name: edge-gateway
      defaultInbound: deny
      allow:
        - source: lan
          proto: tcp
          ports: [22, 80, 443, 41641]
        - source: tailscale
          proto: tcp
          ports: [22, 80, 443]
        - source: tailscale
          proto: udp
          ports: [41641]
    - vmid: 300
      name: app-host
      defaultInbound: deny
      allow:
        - source: lan
          proto: tcp
          ports: [22, 32400, 3000, 9090, 3100, 8080, 8088]
        - source: tailscale
          proto: tcp
          ports: [22, 32400, 3000, 8080, 8088]
    - vmid: 400
      name: home-assistant
      defaultInbound: deny
      allow:
        - source: lan
          proto: tcp
          ports: [22, 8123]
        - source: tailscale
          proto: tcp
          ports: [22, 8123]

backupPolicies:
  phase0:
    strategy: local-ssd-temporary
    warning: "SSD-only host: keep retention short until HDD mirror is available"
    retention:
      daily: 3
      weekly: 0
      monthly: 0

validationChecks:
  - name: edge-gateway-tailscale-online
    type: tailscale-status
    target: vmid:100
  - name: home-assistant-http
    type: http
    target: http://home-assistant.local:8123
    expectedStatus: 200
  - name: app-host-plex-http
    type: http
    target: http://app-host.local:32400/web/index.html
    expectedStatus: 200
  - name: app-host-grafana-http
    type: http
    target: http://app-host.local:3000/api/health
    expectedStatus: 200
  - name: app-host-docker-health
    type: docker-health
    target: vmid:300

# -----------------------------------------------------------------------------
# PHASE 1 (WHEN 2 HDD ARRIVE): STORAGE + PROTECTION
# -----------------------------------------------------------------------------

profilesConfig:
  phase1:
    enabledWhen:
      - two_hdds_present
    changes:
      proxmoxNodeZfsCreate:
        - node: proxmox
          name: tank
          devices:
            - /dev/disk/by-id/HDD1
            - /dev/disk/by-id/HDD2
          options:
            raidlevel: mirror
      storages:
        - name: tank-zfs
          node: proxmox
          type: zfspool
          pool: tank
          content: [images, rootdir, backup]
      datasets:
        - tank/media
        - tank/appdata
        - tank/backups
        - tank/ha
      migrationPlan:
        - move: plex-media
          from: /data/media
          to: /tank/media
        - move: app-host-appdata
          from: /opt/naas/appdata
          to: /tank/appdata
        - move: backups
          from: local
          to: tank/backups
      snapshotSchedule:
        - dataset: tank/media
          frequency: daily
        - dataset: tank/appdata
          frequency: daily
      backupRetention:
        daily: 7
        weekly: 4
        monthly: 6
      notes:
        - Prefer PBS when available; keep vzdump as fallback.

# -----------------------------------------------------------------------------
# PHASE 2: HARDENED SEGMENTATION (NO MANAGED SWITCH REQUIRED)
# -----------------------------------------------------------------------------

  phase2:
    enabledWhen:
      - segmentation_required
    networkChanges:
      networks:
        - name: vmbr1
          node: proxmox
          type: bridge
          autostart: true
          comments: "SERVICES internal bridge (no physical uplink)"
        - name: vmbr2
          node: proxmox
          type: bridge
          autostart: true
          comments: "IOT internal bridge (no physical uplink)"
    vmProvision:
      - name: firewall-router
        vmid: 150
        node: proxmox
        ensure: running
        cpu: { cores: 2, type: host }
        memory: { size: 4096, balloon: 2048 }
        disks:
          - interface: scsi
            index: 0
            storage: local-lvm
            size: 32G
            cache: none
            discard: on
            ssd: true
            iothread: true
        networks:
          - interface: net
            index: 0
            model: virtio
            bridge: vmbr0
            firewall: true
          - interface: net
            index: 1
            model: virtio
            bridge: vmbr1
            firewall: true
          - interface: net
            index: 2
            model: virtio
            bridge: vmbr2
            firewall: true
        onboot: true
        protection: true
        tags: [env=lab, role=firewall-router, tier=lan, owner=loic]
        description: "OPNsense router/firewall for SERVICES/IOT segmentation"
        agent: false
    reattachments:
      - vmid: 300
        vm: app-host
        bridge: vmbr1
      - vmid: 400
        vm: home-assistant
        bridge: vmbr2
      - vmid: 100
        vm: edge-gateway
        bridge: vmbr0
        optionalSecondaryBridge: vmbr1
    tailscaleSubnetRouting:
      preferredInstallTargets:
        - edge-gateway
        - firewall-router
      advertiseRoutes:
        - 10.20.0.0/24 # services
        - 10.30.0.0/24 # iot
    firewallMatrix:
      defaults:
        interSegment: deny
      allows:
        - from: iot
          to: home-assistant
          ports: [8123, 1883]
        - from: edge-gateway
          to: app-host
          ports: [22, 80, 443]
        - from: lan-or-tailscale-admin
          to: management-ssh
          ports: [22]
      denies:
        - from: services
          to: proxmox-mgmt
        - from: iot
          to: proxmox-mgmt
